<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis History - StockSense AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='analysis_history.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for stats visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-chart-line"></i>
                <span>StockSense AI</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{{ url_for('index') }}" class="nav-link">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('analysis_history') }}" class="nav-link active">
                        <i class="fas fa-history"></i> Analysis History
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('watchlist') }}" class="nav-link">
                        <i class="fas fa-star"></i> Watchlist
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('profile') }}" class="nav-link">
                        <i class="fas fa-user"></i> {{ user_name }}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('logout') }}" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
                        {{ message }}
                        <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-history"></i> Analysis History</h1>
            <p class="page-subtitle">Review and manage your previous stock analyses</p>
        </div>

        <!-- Analysis History Table -->
        {% if history %}
        <div class="history-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Your Analysis Reports</h2>
                <p>Click "View Analysis" to see detailed results or "Download Report" to save the analysis</p>
            </div>
            
            <!-- Search and Filters -->
            <div class="table-controls">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search by company name or sector..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-info">
                    Showing <span id="startItem">1</span> to <span id="endItem">{{ history|length }}</span> of <span id="totalItems">{{ history|length }}</span> analyses
                </div>
            </div>
            
            <div class="history-table-container">
                <table class="data-table sortable">
                    <thead>
                        <tr>
                            <th class="no-col">No</th>
                            <th class="sortable" data-sort="company_name">
                                <span>Company Name</span>
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="sector">
                                <span>Sector</span>
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="analysis_date">
                                <span>Analysis Date</span>
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="overall_sentiment">
                                <span>Sentiment</span>
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="total_articles">
                                <span>Articles</span>
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        {% for analysis in history %}
                        <tr data-company="{{ analysis.company_name.lower() }}" data-sector="{{ analysis.sector.lower() if analysis.sector else '' }}" data-date="{{ analysis.analysis_date }}" data-sentiment="{{ analysis.overall_sentiment.lower() if analysis.overall_sentiment else '' }}" data-articles="{{ analysis.total_articles or 0 }}">
                            <td class="no-col">{{ loop.index }}</td>
                            <td>
                                <div class="company-cell">
                                    <i class="fas fa-building company-icon"></i>
                                    <strong>{{ analysis.company_name }}</strong>
                                    {% if analysis.ticker_symbol %}
                                    <br><small class="ticker-small">{{ analysis.ticker_symbol }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="sector-badge sector-{{ analysis.sector|lower if analysis.sector else 'unknown' }}">{{ analysis.sector or 'Unknown' }}</span>
                            </td>
                            <td>
                                <span class="date-badge">{{ analysis.analysis_date }}</span>
                            </td>
                            <td>
                                {% if analysis.overall_sentiment %}
                                <div class="sentiment-indicator sentiment-{{ analysis.overall_sentiment.lower() }}">
                                    <i class="fas {% if analysis.overall_sentiment == 'Positive' %}fa-smile{% elif analysis.overall_sentiment == 'Negative' %}fa-frown{% else %}fa-meh{% endif %}"></i>
                                    <span>{{ analysis.overall_sentiment }}</span>
                                </div>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="article-count">
                                    <i class="fas fa-newspaper"></i>
                                    {{ analysis.total_articles or 0 }}
                                </span>
                            </td>
                            <td class="actions-cell">
                                <a href="{{ url_for('view_analysis', analysis_id=analysis.id) }}" 
                                   class="btn btn-primary btn-small view-btn">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <button class="btn btn-secondary btn-small download-btn" 
                                        data-id="{{ analysis.id }}" data-company="{{ analysis.company_name }}">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="pagination-container">
                    <button id="prevPage" class="btn btn-outline pagination-btn" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="pageInfo">Page 1 of <span id="totalPages">1</span></span>
                    <button id="nextPage" class="btn btn-outline pagination-btn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Summary Stats -->
        <div class="stats-section">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i> Your Analysis Statistics
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalAnalyses">{{ history|length }}</h3>
                        <p>Total Analyses</p>
                        <small>Companies researched</small>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalArticles">{{ history|sum(attribute='total_articles') or 0 }}</h3>
                        <p>Articles Analyzed</p>
                        <small>Total news processed</small>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="sectorsCovered">{{ history|map(attribute='sector')|reject('equalto', '')|unique|list|length }}</h3>
                        <p>Sectors Covered</p>
                        <small>Different industries</small>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="latestAnalysis">{{ (history|first).created_at if history else 'N/A' }}</h3>
                        <p>Latest Analysis</p>
                        <small>Most recent research</small>
                    </div>
                </div>
            </div>
            
            <!-- Sentiment Distribution Chart -->
            <div class="chart-section">
                <h3>Sentiment Distribution</h3>
                <canvas id="sentimentChart" width="400" height="200"></canvas>
            </div>
        </div>

        {% else %}
        <!-- No Analysis History -->
        <div class="no-history">
            <div class="no-history-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h3>No Analysis History Yet</h3>
            <p>You haven't performed any stock analyses yet. Start by searching for a company to analyze.</p>
            <div class="no-history-actions">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Start Your First Analysis
                </a>
                <a href="{{ url_for('watchlist') }}" class="btn btn-outline">
                    <i class="fas fa-star"></i> Manage Watchlist
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="quick-actions-section">
            <h2 class="section-title">
                <i class="fas fa-bolt"></i> Quick Actions
            </h2>
            
            <div class="quick-actions-grid">
                <a href="{{ url_for('index') }}" class="quick-action-card">
                    <div class="action-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h3>New Analysis</h3>
                    <p>Start a fresh stock analysis</p>
                </a>
                
                <a href="{{ url_for('watchlist') }}" class="quick-action-card">
                    <div class="action-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3>Watchlist</h3>
                    <p>View your tracked stocks</p>
                </a>
                
                <a href="{{ url_for('profile') }}" class="quick-action-card">
                    <div class="action-icon">
                        <i class="fas fa-user-cog"></i>
                    </div>
                    <h3>Settings</h3>
                    <p>Manage your account</p>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3><i class="fas fa-chart-line"></i> StockSense AI</h3>
                <p>Track your investment research journey with comprehensive analysis history and insights.</p>
            </div>
            <div class="footer-section">
                <h4>History Features</h4>
                <ul>
                    <li>Analysis tracking</li>
                    <li>Performance monitoring</li>
                    <li>Report downloads</li>
                    <li>Trend identification</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 StockSense AI. Your investment research history powered by AI.</p>
        </div>
    </footer>

    <script>
        // Pass history data to JavaScript for client-side operations
        const historyData = {{ history|tojson|safe }};
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let sortColumn = '';
        let sortDirection = 'asc';
        let filteredData = [];

        // Auto-hide flash messages
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);

        // Initialize table functionality
        document.addEventListener('DOMContentLoaded', function() {
            filteredData = [...historyData];

            initializeTable();
            initializeChart();
            updateTableDisplay();

            // Explicit initial disable check for single-page data
            const initialTotalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (initialTotalPages <= 1) {
                document.getElementById('nextPage').disabled = true;
                document.getElementById('prevPage').disabled = true;
                document.getElementById('nextPage').title = 'No more pages';
                document.getElementById('prevPage').title = 'No previous pages';
            }
        });

        function initializeTable() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filteredData = historyData.filter(item => 
                    item.company_name.toLowerCase().includes(searchTerm) ||
                    (item.sector && item.sector.toLowerCase().includes(searchTerm))
                );
                currentPage = 1;
                updateTableDisplay();
            });

            // Sorting functionality
            const sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    
                    // Update sort icons
                    sortableHeaders.forEach(h => {
                        h.querySelector('.sort-icon').className = 'fas fa-sort sort-icon';
                    });
                    this.querySelector('.sort-icon').className = 
                        `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon active`;
                    
                    // Sort data
                    filteredData.sort((a, b) => {
                        let valA = getSortValue(a, column);
                        let valB = getSortValue(b, column);
                        
                        let comparison;
                        if (column === 'overall_sentiment') {
                            const sentimentOrder = { 'positive': 2, 'neutral': 1, 'negative': 0 };
                            const aSent = valA ? valA.toLowerCase() : '';
                            const bSent = valB ? valB.toLowerCase() : '';
                            comparison = (sentimentOrder[aSent] || 0) - (sentimentOrder[bSent] || 0);
                        } else if (typeof valA === 'string') {
                            const aStr = valA.toLowerCase();
                            const bStr = valB.toLowerCase();
                            comparison = aStr.localeCompare(bStr);
                        } else {
                            comparison = valA - valB;
                        }
                        
                        return sortDirection === 'asc' ? comparison : -comparison;
                    });
                    
                    currentPage = 1;
                    updateTableDisplay();
                });
            });

            // Pagination
            document.getElementById('prevPage').addEventListener('click', (e) => {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                if (currentPage > 1) {
                    currentPage--;
                    updateTableDisplay();
                } else {
                    e.preventDefault();
                }
            });

            document.getElementById('nextPage').addEventListener('click', (e) => {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTableDisplay();
                } else {
                    e.preventDefault();
                }
            });

            // Download functionality
            const downloadBtns = document.querySelectorAll('.download-btn');
            downloadBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const analysisId = this.dataset.id;
                    const companyName = this.dataset.company;
                    downloadReport(analysisId, companyName, this);
                });
            });
        }

        function getSortValue(item, column) {
            switch (column) {
                case 'company_name': return item.company_name;
                case 'sector': return item.sector || '';
                case 'analysis_date': return new Date(item.analysis_date).getTime();
                case 'overall_sentiment': return item.overall_sentiment || '';
                case 'total_articles': return item.total_articles || 0;
                default: return '';
            }
        }

        function updateTableDisplay() {
            const tbody = document.getElementById('historyTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Clear and repopulate tbody
            tbody.innerHTML = '';
            pageData.forEach((analysis, index) => {
                const globalIndex = startIndex + index + 1;
                const row = createTableRow(analysis, globalIndex);
                tbody.appendChild(row);
            });
            
            // Update pagination info
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalItems').textContent = filteredData.length;
            document.getElementById('startItem').textContent = startIndex + 1;
            document.getElementById('endItem').textContent = Math.min(endIndex, filteredData.length);
            
            // Update button states
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            // Add tooltips for better UX
            document.getElementById('prevPage').title = currentPage === 1 ? 'No previous pages' : 'Go to previous page';
            document.getElementById('nextPage').title = currentPage === totalPages ? 'No more pages' : 'Go to next page';
            
            // Re-attach download listeners
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const analysisId = this.dataset.id;
                    const companyName = this.dataset.company;
                    downloadReport(analysisId, companyName, this);
                });
            });
        }

        function createTableRow(analysis, rowNumber) {
            const tr = document.createElement('tr');
            tr.dataset.company = analysis.company_name.toLowerCase();
            tr.dataset.sector = (analysis.sector || '').toLowerCase();
            tr.dataset.date = analysis.analysis_date;
            tr.dataset.sentiment = (analysis.overall_sentiment || '').toLowerCase();
            tr.dataset.articles = analysis.total_articles || 0;
            
            let sentimentIconClass = 'question';
            if (analysis.overall_sentiment) {
                const sent = analysis.overall_sentiment.toLowerCase();
                if (sent === 'positive') {
                    sentimentIconClass = 'smile';
                } else if (sent === 'negative') {
                    sentimentIconClass = 'frown';
                } else {
                    sentimentIconClass = 'meh';
                }
            }
            const sentimentIcon = `fa-${sentimentIconClass}`;
            
            const sentimentHtml = analysis.overall_sentiment ? 
                `<div class="sentiment-indicator sentiment-${analysis.overall_sentiment.toLowerCase()}">
                    <i class="fas ${sentimentIcon}"></i>
                    <span>${analysis.overall_sentiment}</span>
                </div>` : '<span class="text-muted">N/A</span>';
            
            const tickerHtml = analysis.ticker_symbol ? `<br><small class="ticker-small">${analysis.ticker_symbol}</small>` : '';
            
            tr.innerHTML = `
                <td class="no-col">${rowNumber}</td>
                <td>
                    <div class="company-cell">
                        <i class="fas fa-building company-icon"></i>
                        <strong>${analysis.company_name}</strong>
                        ${tickerHtml}
                    </div>
                </td>
                <td>
                    <span class="sector-badge sector-${(analysis.sector || 'unknown').toLowerCase().replace(/\s+/g, '-')}">${analysis.sector || 'Unknown'}</span>
                </td>
                <td>
                    <span class="date-badge"><i class="fas fa-calendar-alt"></i> ${analysis.analysis_date}</span>
                </td>
                <td>
                    ${sentimentHtml}
                </td>
                <td>
                    <span class="article-count">
                        <i class="fas fa-newspaper"></i>
                        ${analysis.total_articles || 0}
                    </span>
                </td>
                <td class="actions-cell">
                    <a href="/view_analysis/${analysis.id}" class="btn btn-primary btn-small view-btn">
                        <i class="fas fa-eye"></i> View
                    </a>
                    <button class="btn btn-secondary btn-small download-btn" data-id="${analysis.id}" data-company="${analysis.company_name}">
                        <i class="fas fa-download"></i> Download
                    </button>
                </td>
            `;
            return tr;
        }

        // Download report function - now uses backend endpoint
        async function downloadReport(analysisId, companyName, button) {
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
                button.disabled = true;
                
                const response = await fetch(`/download_analysis/${analysisId}`);
                if (!response.ok) {
                    throw new Error('Failed to download report');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_${analysisId}_${companyName.replace(/\s+/g, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('Report downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download report. Please try again.', 'error');
            } finally {
                button.innerHTML = '<i class="fas fa-download"></i> Download';
                button.disabled = false;
            }
        }

        // Show notification function
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
                <span class="closebtn" onclick="this.parentElement.remove();">&times;</span>
            `;
            
            const container = document.querySelector('.flash-container') || document.createElement('div');
            if (!document.querySelector('.flash-container')) {
                container.className = 'flash-container';
                document.body.insertBefore(container, document.body.firstChild);
            }
            
            container.appendChild(notification);
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                notification.style.transition = 'all 0.3s ease';
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-10px)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Initialize sentiment chart
        function initializeChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            const positiveCount = historyData.filter(item => item.overall_sentiment === 'Positive').length;
            const negativeCount = historyData.filter(item => item.overall_sentiment === 'Negative').length;
            const neutralCount = historyData.filter(item => item.overall_sentiment === 'Neutral').length;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [positiveCount, negativeCount, neutralCount],
                        backgroundColor: [
                            '#10B981', // Green
                            '#EF4444', // Red
                            '#6B7280'  // Gray
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Responsive table handling
        function handleResponsiveTable() {
            const table = document.querySelector('.data-table');
            if (window.innerWidth < 768) {
                table.classList.add('mobile-table');
            } else {
                table.classList.remove('mobile-table');
            }
        }

        window.addEventListener('resize', handleResponsiveTable);
        handleResponsiveTable();
    </script>
</body>
</html>